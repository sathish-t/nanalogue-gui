<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Content Security Policy restricting scripts and styles to same-origin. -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'">
  <title>QC Configuration - nanalogue-gui</title>
  <!-- Shared base styles and QC-specific styles. -->
  <link rel="stylesheet" href="../shared/styles.css">
  <link rel="stylesheet" href="qc.css">
</head>
<body>
  <!-- QC configuration page root container. -->
  <div id="qc-config-app">
    <!-- Header with back navigation and page title. -->
    <header>
      <button type="button" id="btn-back" class="back-button">&larr; Back</button>
      <h1>QC Configuration</h1>
    </header>

    <main>
      <!-- BAM source selection: local file or remote URL. -->
      <section class="config-section">
        <h2>BAM Source</h2>
        <!-- Reusable BAM source input with file/URL toggle. -->
        <bam-resource-input id="bam-source"></bam-resource-input>
      </section>

      <!-- Panel displaying metadata from the selected BAM file. -->
      <section class="config-section" id="file-info-section">
        <h2>File Info</h2>
        <div id="file-info-content">
          <p class="placeholder-text">Will load upon BAM file specification</p>
        </div>
      </section>

      <!-- Modification type filter (e.g. +T for basecalled-strand thymidine). -->
      <section class="config-section">
        <!-- Reusable modification filter input with validation. -->
        <mod-filter-input id="mod-filter"></mod-filter-input>
      </section>

      <!-- Optional genomic region to restrict QC analysis. -->
      <section class="config-section">
        <h2>Region <span class="optional">(optional)</span></h2>
        <label for="region" class="visually-hidden">Region</label>
        <input type="text" id="region" placeholder="e.g. chr3, chrI:1000-50000">
        <!-- Checkbox to restrict to reads fully spanning the region. -->
        <label class="checkbox-label" id="full-region-label">
          <input type="checkbox" id="full-region" disabled>
          Restrict to reads that pass through region completely
        </label>
        <!-- Optional sub-region to restrict modification filtering. -->
        <label for="mod-region" class="visually-hidden">Restrict mods to region</label>
        <h2>Restrict mods to region <span class="optional">(optional)</span></h2>
        <input type="text" id="mod-region" placeholder="e.g. chr3, chrI:2000-40000">
      </section>

      <!-- Read length histogram granularity selection. -->
      <section class="config-section">
        <h2>Read length histogram resolution</h2>
        <label for="read-length-granularity" class="visually-hidden">Read length histogram resolution</label>
        <select id="read-length-granularity">
          <option value="1">Very fine (1 bp)</option>
          <option value="10">Fine (10 bp)</option>
          <option value="100">Standard (100 bp)</option>
          <option value="1000" selected>Coarse (1000 bp)</option>
          <option value="10000">Very coarse (10 kb)</option>
        </select>
      </section>

      <!-- Percentage of reads to sample for QC analysis. -->
      <section class="config-section">
        <h2>Sample fraction</h2>
        <div class="input-with-unit">
          <label for="sample-fraction" class="visually-hidden">Sample fraction</label>
          <input type="number" id="sample-fraction" value="5" min="0.01" max="100" step="any">
          <span class="unit">%</span>
        </div>
        <p class="hint warning">On large files/regions, you must subsample to avoid program crashes or heavy data downloads from remote URLs.</p>
      </section>

      <!-- Window size for the windowed analogue density calculation. -->
      <section class="config-section">
        <h2>Window size <span class="optional">(for windowed density)</span></h2>
        <div class="input-with-unit">
          <label for="window-size" class="visually-hidden">Window size</label>
          <input type="number" id="window-size" value="300" min="10" max="10000" step="10">
          <span class="unit">bases of interest</span>
        </div>
        <p class="hint">Windows are counted in bases of interest (e.g., thymidines), not total genomic bases.</p>
      </section>

      <!-- Collapsible advanced filtering options. -->
      <details id="advanced-options" class="config-section">
        <summary><h2 class="advanced-summary-heading">Advanced Options</h2></summary>

        <!-- Mapping quality and alignment type filters. -->
        <fieldset class="advanced-group">
          <legend>Mapping Filters</legend>
          <div class="advanced-row">
            <label for="mapq-filter">MAPQ filter</label>
            <div class="input-with-unit">
              <input type="number" id="mapq-filter" min="0" max="255" step="1" placeholder="e.g. 20">
            </div>
          </div>
          <label class="checkbox-label">
            <input type="checkbox" id="exclude-mapq-unavail">
            Exclude reads with unavailable MAPQ
          </label>
          <div class="advanced-row">
            <label>Read filter</label>
            <div class="read-filter-checkboxes">
              <label class="checkbox-label"><input type="checkbox" value="primary_forward"> primary_forward</label>
              <label class="checkbox-label"><input type="checkbox" value="primary_reverse"> primary_reverse</label>
              <label class="checkbox-label"><input type="checkbox" value="secondary_forward"> secondary_forward</label>
              <label class="checkbox-label"><input type="checkbox" value="secondary_reverse"> secondary_reverse</label>
              <label class="checkbox-label"><input type="checkbox" value="supplementary_forward"> supplementary_forward</label>
              <label class="checkbox-label"><input type="checkbox" value="supplementary_reverse"> supplementary_reverse</label>
              <label class="checkbox-label"><input type="checkbox" value="unmapped"> unmapped</label>
            </div>
          </div>
        </fieldset>

        <!-- Sequence and alignment length filters. -->
        <fieldset class="advanced-group">
          <legend>Length Filters</legend>
          <div class="advanced-row">
            <label for="min-seq-len">Min sequence length</label>
            <div class="input-with-unit">
              <input type="number" id="min-seq-len" min="0" step="1" placeholder="e.g. 500">
              <span class="unit">bp</span>
            </div>
          </div>
          <div class="advanced-row">
            <label for="min-align-len">Min alignment length</label>
            <div class="input-with-unit">
              <input type="number" id="min-align-len" min="0" step="1" placeholder="e.g. 300">
              <span class="unit">bp</span>
            </div>
          </div>
        </fieldset>

        <!-- Read ID file filter. -->
        <fieldset class="advanced-group">
          <legend>Read ID Filters</legend>
          <div class="file-input-row">
            <label for="read-id-path" class="visually-hidden">Read ID file path</label>
            <input type="text" id="read-id-path" placeholder="Select a text file with one read ID per line" readonly>
            <button type="button" id="btn-browse-read-ids" class="small-button">Browse</button>
            <!-- Button to clear the selected read ID file. Hidden when no file is selected. -->
            <button type="button" id="btn-clear-read-ids" class="small-button hidden">Clear</button>
          </div>
          <p id="read-id-count" class="hint"></p>
        </fieldset>

        <!-- Base quality, trim, and probability rejection filters for modifications. -->
        <fieldset class="advanced-group">
          <legend>Modification Filters</legend>
          <div class="advanced-row">
            <label for="base-qual-filter-mod">Base quality filter</label>
            <div class="input-with-unit">
              <input type="number" id="base-qual-filter-mod" min="0" max="93" step="1" placeholder="e.g. 10">
            </div>
          </div>
          <div class="advanced-row">
            <label for="trim-read-ends-mod">Trim read ends</label>
            <div class="input-with-unit">
              <input type="number" id="trim-read-ends-mod" min="0" step="1" placeholder="e.g. 50">
              <span class="unit">bp</span>
            </div>
          </div>
          <div class="advanced-row">
            <label>Mod probability filter</label>
            <div class="mod-prob-filter-row">
              <label for="mod-prob-low" class="visually-hidden">Low probability bound</label>
              <span>Reject</span>
              <input type="number" id="mod-prob-low" min="0" max="255" step="1" placeholder="0" class="narrow-input">
              <label for="mod-prob-high" class="visually-hidden">High probability bound</label>
              <span>&ndash;</span>
              <input type="number" id="mod-prob-high" min="0" max="255" step="1" placeholder="255" class="narrow-input">
              <span class="hint-inline">(both exclusive)</span>
            </div>
          </div>
        </fieldset>

        <!-- Random seed for reproducible subsampling. -->
        <fieldset class="advanced-group">
          <legend>Sampling</legend>
          <div class="advanced-row">
            <label for="sample-seed">Sample seed</label>
            <div class="input-with-unit">
              <input type="number" id="sample-seed" min="0" max="4294967295" step="1">
            </div>
          </div>
          <p class="hint">Only used when sample fraction is below 100%.</p>
        </fieldset>
      </details>

      <!-- Submit button to start QC generation; disabled until a BAM is selected. -->
      <div class="action-row">
        <button type="button" id="btn-generate" class="primary-button" disabled>Generate QC</button>
      </div>

      <!-- Full-screen loading overlay with per-source progress counters. -->
      <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p id="progress-modifications">Loading reads for modification data:</p>
        <p id="progress-windows">Loading reads for window data:</p>
        <!-- Progress counter for sequence table data loading. -->
        <p id="progress-sequences">Loading reads for sequences:</p>
      </div>
    </main>
  </div>

  <!-- Dialog showing full BAM file metadata (contigs and modifications). -->
  <dialog id="more-info-dialog">
    <h2>BAM File Details</h2>
    <div id="more-info-content"></div>
    <button type="button" id="more-info-close" class="primary-button">Close</button>
  </dialog>

  <!-- Bundled QC configuration script handling form interactions and IPC. -->
  <script src="qc-config.js"></script>
</body>
</html>
