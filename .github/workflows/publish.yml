# Release workflow for nanalogue-gui
# Validates version tag and builds on all platforms
# Triggers on GitHub Release or manual dispatch

name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  version-check:
    name: Verify versions match
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
    steps:
      - uses: actions/checkout@v6
      - name: Check tag matches version
        id: check
        if: github.event_name == 'release'
        run: |
          TAG="${{ github.event.release.tag_name }}"
          TAG_V="${TAG#v}"
          V=$(jq -r '.version' package.json)
          [ "$TAG_V" = "$V" ] || { echo "Tag $TAG_V != package.json $V"; exit 1; }
          echo "version=$TAG_V" >> "$GITHUB_OUTPUT"

  build:
    name: Build (${{ matrix.target }})
    needs: version-check
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - target: x86_64-apple-darwin
            runner: macos-15-intel
          - target: aarch64-apple-darwin
            runner: macos-latest

          # Linux glibc builds (via Docker with pypa manylinux containers)
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            use_docker: true
            container: quay.io/pypa/manylinux_2_28_x86_64
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
            use_docker: true
            container: quay.io/pypa/manylinux_2_28_aarch64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # macOS: direct build
      - name: Setup Node.js
        if: ${{ !matrix.use_docker }}
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install npm dependencies
        if: ${{ !matrix.use_docker }}
        run: npm ci

      - name: Build
        if: ${{ !matrix.use_docker }}
        run: npm run build

      - name: Run tests
        if: ${{ !matrix.use_docker }}
        run: npm test
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      # Linux: Docker container build
      - name: Build and test (Linux via Docker)
        if: ${{ matrix.use_docker }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e ANTHROPIC_API_KEY \
            -e GOOGLE_API_KEY \
            -e OPENAI_API_KEY \
            ${{ matrix.container }} \
            bash -c '
              set -e

              # Install Node.js 22 via NodeSource
              curl -fsSL https://rpm.nodesource.com/setup_22.x | bash -
              yum install -y nodejs

              # Print Node.js version for debugging
              echo "Node.js version: $(node --version)"
              echo "npm version: $(npm --version)"

              # Install npm dependencies, build, and test
              npm ci

              # @pydantic/monty has no native linux-arm64 package;
              # install the WASM fallback so tests pass on aarch64
              npm install --force @pydantic/monty-wasm32-wasi

              npm run build
              npm test
            '

  package:
    name: Package binaries
    needs: [version-check, build]
    uses: ./.github/workflows/package.yml
    with:
      version: ${{ needs.version-check.outputs.version }}
    permissions:
      contents: write
