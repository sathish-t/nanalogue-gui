#!/usr/bin/env bash
# Keeps package-lock.json in sync with package.json so that
# npm ci in CI does not fail on optional-dependency mismatches.

# Load nvm (shell function, not on PATH in non-interactive shells)
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
# shellcheck source=/dev/null
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

if git diff --cached --name-only | grep -q '^package\.json$'; then
  # Use the staged version of package.json for lock file generation
  cp package.json package.json.bak
  trap '[ -f package.json.bak ] && mv package.json.bak package.json' EXIT INT TERM

  staged_pkg=$(mktemp)
  git show :package.json > "$staged_pkg"
  cp "$staged_pkg" package.json
  rm "$staged_pkg"

  # Use Node 22 (minimum supported version) so the lock file is
  # compatible with npm ci on both Node 22 and Node 24 in CI.
  if ! nvm exec 22 npm install --package-lock-only --ignore-scripts; then
    echo "pre-commit: npm install --package-lock-only failed, aborting commit" >&2
    exit 1
  fi

  mv package.json.bak package.json
  trap - EXIT INT TERM
  git add package-lock.json
fi
